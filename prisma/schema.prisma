generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
	provider = "postgresql"
}
// prisma/schema.prisma

enum UserRole {
  INVESTOR
  STARTUP
  ADMIN
}

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum VerificationType {
  IDENTITY
  ROLE
  ACTIVITY
  COMMUNITY
}

enum VerificationStageStatus {
  PENDING
  IN_REVIEW
  APPROVED
  REJECTED
}

enum VerificationActor {
  USER
  ADMIN
  SYSTEM
}

enum PostCategory {
  FINTECH
  HEALTH
  AI
  OTHER
}

enum PostType {
  FUNDING_REQUEST
  INVESTMENT_OFFER
  UPDATE
  ANNOUNCEMENT
  MILESTONE
  OTHER
}

enum PointsTxType {
  PURCHASE
  SPEND
  REFUND
  ADJUSTMENT
}

enum ConversationStatus {
  PENDING
  ACTIVE
  REJECTED
  CLOSED
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  password      String
  role          UserRole
  firstName     String
  middleName    String?
  lastName      String
  dob           DateTime
  phoneNumber   String

  isVerified    Boolean  @default(false)
  verifiedAt    DateTime?
  JWtToken      String?
  JwtIssuedAt  DateTime?

  sessions      Session[]
  wallet        PointsWallet?
  investor      InvestorProfile?
  startup       StartupProfile?

  sentReviews   Review[] @relation("Reviewer")
  receivedReviews Review[] @relation("Reviewee")

  conversationsAsRequester Conversation[] @relation("Requester")
  conversationsAsReceiver  Conversation[] @relation("Receiver")

  messages      Message[]
  promotions    Promotion[]
  adminActions  AdminAction[]
  otp           OTP?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  verificationApplications VerificationApplication[]
  posts                    Post[]
  reviewedVerifications    VerificationApplication[] @relation("VerificationReviewer")
  
  // Multi-stage verification
  verificationStages       VerificationStage[]
  reviewedStages          VerificationStage[] @relation("StageReviewer")
  activityMetrics         ActivityMetric?
  communityMetrics        CommunityMetric?
  
  // Daily message quota tracking
  messageQuota            MessageQuota?
}

model Session {
  id          String   @id @default(uuid())
  user        User     @relation(fields: [userId], references: [id])
  userId      String
  accessToken String

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  expiresAt   DateTime
  revokedAt   DateTime?
  userAgent   String?
  ipAddress   String?
}

model PointsWallet {
  id        String @id @default(uuid())
  user      User   @relation(fields: [userId], references: [id])
  userId    String @unique
  balance   Int    @default(0)

  transactions PointsTransaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PointsTransaction {
  id        String        @id @default(uuid())
  wallet    PointsWallet @relation(fields: [walletId], references: [id])
  walletId  String
  amount    Int           // +credit, -debit
  type      PointsTxType
  reference String?       // payment id / conversation id
  note      String?
  status    String        @default("pending") // pending, success, failed
  balanceBefore Int?
  balanceAfter  Int?

  createdAt DateTime @default(now())
}

model InvestorProfile {
  id          String   @id @default(uuid())
  user        User     @relation(fields: [userId], references: [id])
  userId      String   @unique

  bio         String?
  firmName    String?
  website     String?
  minTicket   Int?
  maxTicket   Int?

  photo       String? // URL or path to profile photo
  kycDocumentType String? // e.g., 'passport', 'aadhaar', etc.
  kycDocumentNumber String?
  kycDocumentUrl String? // URL or path to uploaded KYC document

  categories  Category[] @relation("InvestorCategories")

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model StartupProfile {
  id          String   @id @default(uuid())
  user        User     @relation(fields: [userId], references: [id])
  userId      String   @unique

  name        String
  description String?
  website     String?
  stage       String?   // idea, seed, series-a (string for MVP)

  photo       String? // URL or path to profile photo
  kycDocumentType String? // e.g., 'incorporation', 'gst', etc.
  kycDocumentNumber String?
  kycDocumentUrl String? // URL or path to uploaded KYC document

  categories  Category[] @relation("StartupCategories")

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Conversation {
  id            String   @id @default(uuid())
  requester     User     @relation("Requester", fields: [requesterId], references: [id])
  requesterId   String
  receiver      User     @relation("Receiver", fields: [receiverId], references: [id])
  receiverId    String

  status        ConversationStatus @default(PENDING)
  pointsCost    Int

  messages      Message[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([requesterId, receiverId])
}

model Message {
  id             String        @id @default(uuid())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  conversationId String
  sender         User          @relation(fields: [senderId], references: [id])
  senderId       String
  content        String

  // Disappearing message feature
  expiresAt      DateTime?     // Absolute expiration timestamp (min 1 hour from creation)
  isExpired      Boolean       @default(false) // Soft delete flag for cleanup
  
  // Read status (optional for future enhancement)
  isRead         Boolean       @default(false)
  readAt         DateTime?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  @@index([conversationId, createdAt])
  @@index([expiresAt])
  @@index([senderId])
}

model Review {
  id          String @id @default(uuid())
  reviewer    User   @relation("Reviewer", fields: [reviewerId], references: [id])
  reviewerId  String
  reviewee    User   @relation("Reviewee", fields: [revieweeId], references: [id])
  revieweeId  String

  rating      Int    // 1â€“5
  comment     String?

  createdAt   DateTime @default(now())
  isVerified    Boolean  @default(false)
  verifiedAt    DateTime?
}

model Promotion {
  id          String @id @default(uuid())
  user        User   @relation(fields: [userId], references: [id])
  userId      String
  pointsSpent Int
  startsAt    DateTime
  endsAt      DateTime
  isActive    Boolean @default(true)
  createdAt   DateTime @default(now())
}

model VerificationApplication {
  id          String   @id @default(uuid())
  user        User     @relation(fields: [userId], references: [id])
  userId      String
  status      VerificationStatus @default(PENDING)
  companyName String?
  domain      String?
  documents   String? // comma-separated links or JSON
  appliedAt   DateTime @default(now())
  reviewedAt  DateTime?
  reviewerId  String?
  reviewer    User?    @relation("VerificationReviewer", fields: [reviewerId], references: [id])
  note        String?
}

model Post {
  id          String       @id @default(uuid())
  author      User         @relation(fields: [authorId], references: [id])
  authorId    String
  title       String
  content     String
  imageUrl    String?      // Supabase S3 URL
  category    PostCategory
  postType    PostType     @default(UPDATE)
  tags        String[]     @default([])
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  @@index([authorId])
  @@index([category])
  @@index([postType])
}

model Category {
  id        String @id @default(uuid())
  name      String @unique

  investors InvestorProfile[] @relation("InvestorCategories")
  startups  StartupProfile[]  @relation("StartupCategories")
}

model AdminAction {
  id        String @id @default(uuid())
  admin     User   @relation(fields: [adminId], references: [id])
  adminId   String
  action    String
  targetId  String?
  note      String?

  createdAt DateTime @default(now())
}

model OTP {
  id        String   @id @default(uuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String   @unique
  hashedOtp String
  attempts  Int      @default(0)
  expiresAt DateTime
  createdAt DateTime @default(now())
}

// Multi-Stage Verification System

model VerificationStage {
  id          String   @id @default(uuid())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String
  
  type        VerificationType
  status      VerificationStageStatus @default(PENDING)
  
  // Metadata stores type-specific verification data as JSON
  // Examples:
  // - IDENTITY: { documentType, documentNumber, documentUrls, facePhotoUrl }
  // - ROLE: { proofType, proofUrls, accreditationData, incorporationDetails }
  // - ACTIVITY: { score, metrics, lastCalculated }
  // - COMMUNITY: { trustScore, endorsementCount, reviewScore }
  metadata    Json?
  
  // Audit trail
  submittedBy VerificationActor @default(USER)
  reviewedBy  VerificationActor?
  reviewer    User?    @relation("StageReviewer", fields: [reviewerId], references: [id])
  reviewerId  String?
  reviewNote  String?
  
  // Auto-expiry for time-limited verifications
  expiresAt   DateTime?
  
  submittedAt DateTime @default(now())
  reviewedAt  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([userId, type])
  @@index([status])
  @@index([type])
}

model ActivityMetric {
  id                    String   @id @default(uuid())
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId                String   @unique
  
  // Interaction metrics
  conversationsStarted  Int      @default(0)
  conversationsReceived Int      @default(0)
  messagesExchanged     Int      @default(0)
  
  // Platform engagement
  postsCreated          Int      @default(0)
  reviewsGiven          Int      @default(0)
  reviewsReceived       Int      @default(0)
  
  // Investment/Deal metrics (role-specific)
  dealsInitiated        Int      @default(0)
  dealsCompleted        Int      @default(0)
  
  // Calculated score (0-100)
  activityScore         Float    @default(0)
  
  lastCalculatedAt      DateTime @default(now())
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model CommunityMetric {
  id                  String   @id @default(uuid())
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId              String   @unique
  
  // Trust indicators
  averageRating       Float    @default(0)
  totalReviews        Int      @default(0)
  verifiedReviews     Int      @default(0)
  
  // Endorsements (can be from other verified users)
  endorsementCount    Int      @default(0)
  endorsedByVerified  Int      @default(0)
  
  // Response metrics
  responseRate        Float    @default(0)
  averageResponseTime Int?     // in minutes
  
  // Calculated trust score (0-100)
  trustScore          Float    @default(0)
  
  lastCalculatedAt    DateTime @default(now())
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

// Daily message quota tracking (20 free messages per day, then points-based)
model MessageQuota {
  id                String   @id @default(uuid())
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId            String   @unique
  
  // Daily quota tracking
  messagesSentToday Int      @default(0)
  quotaDate         DateTime @default(now()) // Date for which this quota applies
  
  // Configuration
  dailyFreeLimit    Int      @default(20)
  pointsPerMessage  Int      @default(10) // Points to deduct after free limit
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([userId, quotaDate])
}
